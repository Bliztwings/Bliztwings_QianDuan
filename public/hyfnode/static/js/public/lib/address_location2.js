function autoPostion(){waiting("正在定位  "),AMap?AMap.plugin("AMap.Geolocation",function(){(geolocation=new AMap.Geolocation({enableHighAccuracy:!0,timeout:1e4,maximumAge:0,convert:!0})).getCurrentPosition(),AMap.event.addListener(geolocation,"error",function(e){var t="获取数据失败";switch(e.info){case"PERMISSION_DENIED":t+="，浏览器阻止了定位操作";break;case"POSITION_UNAVAILBLE":t+="，无法获得当前位置";break;case"TIMEOUT":t+="，定位超时";break;default:t+="，请检查GPS或网络连接是否正常"}stopLocate(t)}),AMap.event.addListener(geolocation,"complete",function(e){e.accuracy?getLocateInfo(e.position.getLng(),e.position.getLat(),!0):stopLocate()})}):stopLocate("暂无定位数据，请手动填写地址")}function getLocateInfo(e,t,a){if(AMap){var i=new AMap.LngLat(e,t);AMap.service(["AMap.Geocoder"],function(){(mGeocoder=new AMap.Geocoder({radius:100,extensions:"base"})).getAddress(i,function(i,r){if("complete"===i&&"OK"===r.info){var o=r.regeocode.formattedAddress,n=r.regeocode.addressComponent,s=o.replace(new RegExp(n.province+n.city+n.district),"").replace(n.streetNumber,""),c="";n.township&&(c+=n.township),n.street&&(c+=n.street),n.streetNumber&&(c+=n.streetNumber.replace(/号/,"")+"号");var d={addrName:s,city:n.city||n.province,citycode:n.citycode,district:n.district,addrDetail:c,lng:e,lat:t};if(!a)return d;verifyAddress(d)}else stopLocate()})})}else stopLocate("暂无定位数据，请手动填写地址")}function autoComplete(e,t){if(!(t=$.trim(t))||!e)return hideSearchList(),hideUserWin(),!1;AMap?AMap.service(["AMap.PlaceSearch"],function(){(placeSearch=new AMap.PlaceSearch({city:e,pageSize:6,extensions:"all"})).search(t,function(t,a){var i=[];if("complete"==t){var r=a.poiList.count;if((r=r>6?6:r)>0){for(var o="",n=0;n<r;n++){var s=a.poiList.pois[n];if(s.cityname.indexOf(e)>-1||s.adname.indexOf(e)>-1){i[n]={addrName:s.name,city:s.cityname,citycode:s.citycode,district:s.adname,addrDetail:s.address,lng:s.location.lng,lat:s.location.lat};var c='"'+i[n].addrName+'"',d='"'+i[n].city+'"',l='"'+i[n].citycode+'"',p='"'+i[n].district+'"',h='"'+i[n].addrDetail+'"',u='"'+i[n].lng+'"',$='"'+i[n].lat+'"',m=i[n].city+" "+i[n].district+" "+i[n].addrDetail;o+="<div onclick='selectSearchList("+c+","+d+","+l+","+p+","+h+","+u+","+$+");' style='cursor:pointer;'>"+i[n].addrName+"<br/><span style='color:#999;font-size:0.9em'>"+m+"</span></div><div class='borderD'></div>"}}o.length?showSearchList(o+="<div onclick='showUserWin();' style='text-align:center;color:#00dbf5;margin-left:0'>没有想要的地址，尝试手动选择市、区</div>"):showUserWin()}else showUserWin()}else showUserWin()})}):showUserWin()}function waiting(e){$("#wait_msg").text(e),$(".waiting").show(),setTimeout(function(){$(".waiting").on("click",function(){stopLocate()})},2e3)}function locateFinish(){$(".waiting").hide(),$("#location_btn").one("click",function(){autoPostion()})}function stopLocate(){$(".waiting").hide(),showError(arguments[0]?arguments[0]:"请检查网络连接，开启GPS",!0)}function showMainWin(){$("#searchList").empty(),$("#searchWin").hide(),$("#userWin").hide(),$("#mainWin").show()}function showSearch(){var e=$.trim($("#addr_name").val());if(e){if(1==SCFlag)t=$("#home_city_sel option:selected").val();else var t=$("#cmbCity option:selected").val();autoComplete(t,e),$("#searchInp_clear").show()}else $("#searchInp_clear").hide();$("#mainWin").hide(),$("#userWin").hide(),$("#searchWin").show(),$("#searchInp").focus().val(e),xbtnStatus($("#searchInp")[0])}function showSearchList(e){$("#userWin").hide(),$("#searchList").html(e).show()}function showUserWin(){if(0==$("#userWin:visible").length){if(1==SCFlag)var e=$("#home_city_sel option:selected").val(),t="";else var e=$("#cmbCity option:selected").val(),t=$("#cmbArea option:selected").val();selectedCity2(e,t)}setBtnStatus2(),$("#searchList").empty().hide(),$("#userWin").show(),$("#searchInp").focus(),xbtnStatus($("#searchInp")[0])}function hideSearchList(){$("#searchList").empty().hide()}function hideUserWin(){$("#userWin").hide()}function autoSearch(e){var t=$.trim($(e).val());if(!t)return hideSearchList(),hideUserWin(),!1;if(1==SCFlag)a=$("#home_city_sel option:selected").val();else var a=$("#cmbCity option:selected").val();autoComplete(a,t)}function selectSearchList(e,t,a,i,r,o,n){verifyAddress({addrName:e,city:t,citycode:a,district:i,addrDetail:r,lng:o,lat:n})}function verifyAddress(e){var t=Math.floor(127*Math.random()+1);jqueryXhr&&jqueryXhr.abort(),jqueryXhr=$.ajax({url:"/hyfnode/base/address/validate",type:"POST",async:!0,timeout:2e3,data:{category_id:category_id,city:e.city,area:e.district,address_line_1:e.addrName,customer_lng:e.lng,customer_lat:e.lat,flag:t},dataType:"json",complete:function(e,t){locateFinish(),jqueryXhr=null},success:function(t,a,i){selectedCity(e.city,e.district),returnSearchAddr(e)},error:function(t,a,i){selectedCity(e.city,e.district),returnSearchAddr(e)}})}function clearKeyword(){$("#searchInp").val(""),$("#searchList").empty()}function returnSearchAddr(e){$(":hidden[name='customer_lng']").val(e.lng),$(":hidden[name='customer_lat']").val(e.lat),$("#addr_name").val(e.addrName),$("#home_city").hide(),$("#cmbArea_wrap").show(),SCFlag=2,$("#select_wrap").show(),setSaveBtn(),showMainWin()}function resetLngLat(){$(":hidden[name='customer_lng']").val(0),$(":hidden[name='customer_lat']").val(0)}function showError(e){if(!errFlag){var t=!!arguments[1];t&&(errFlag=1),$("#show_mes").html(e),$("#codFloat").show(),setTimeout(function(){if($("#show_mes").html(""),$("#codFloat").hide(),t){var e=window.location.href;window.location.href=e.replace(/&pos=no/,"")+"&pos=no"}},2e3)}}function checkform(){var e=$.trim($("#username").val()),t=$(":radio[name='gender']:checked").length,a=$.trim($("#tel").val()),i=$.trim($("#addr_name").val()),r=$("#cmbCity option:selected").val(),o=$("#cmbArea option:selected").val(),n=$.trim($("#detail").val());if(""==e)return showError("姓名不能为空"),!1;if(t<1)return showError("您是女士还是先生呢？"),!1;var s=/^1[3-8]\d{9}$/;return""==a?(showError("手机号不能为空"),!1):s.test(a)?r&&""!=r&&"请选择城市"!=r?""==i?(showError("小区名或者大厦名不能为空"),!1):o&&""!=o&&"请先选择区域"!=o?""==n?(showError("详细地址不能为空"),!1):($("#area_id").val($("#cmbArea").find("option:selected").attr("rel")),void $("#save_address").prop("disabled",!0).css({opacity:".5"})):(showError("区域不能为空"),!1):(showError("城市不能为空"),!1):(showError("请正确填写手机号码"),!1)}function xbtnStatus(e){var t=$(e).val(),a=$(e).attr("id")+"_clear";$.trim(t).length>0?$("#"+a).show():$("#"+a).hide()}function clearInput(e,t){$("#"+t).val(""),$(e).hide(),"searchInp"==t&&($("#searchList").empty(),$("#confirm_address").prop("disabled",!0).css({opacity:".5"}),$("#userWin").hide()),"tel"!=t&&"username"!=t&&"addr_name"!=t&&"detail"!=t||$("#save_address").prop("disabled",!0).css({opacity:".5"})}function setSaveBtn(){var e=$.trim($("#username").val()),t=$(":radio[name='gender']:checked").length,a=$.trim($("#tel").val()),i=$.trim($("#addr_name").val()),r=$("#cmbCity option:selected").val(),o=$("#cmbArea option:selected").val(),n=$.trim($("#detail").val()),s=!0,c=/^1[3-8]\d{9}$/;return""!=a&&c.test(a)||(s=!1),e&&t&&s&&i&&r&&o&&n?($("#save_address").prop("disabled",!1).css({opacity:"1"}),!0):($("#save_address").prop("disabled",!1).css({opacity:".5"}),!1)}function selectedCity(e,t){var a=!1;if(e){e=e.replace(/市/,"");var i=$("#cmbCity").find("option[value='"+e+"']");i.prop("selected",!0);var r=i.attr("city_sn");r||(t=t.replace(/市/,""),(i=$("#cmbCity").find("option[value='"+t+"']")).prop("selected",!0),(r=i.attr("city_sn"))&&(a=!0));var o=$("#area_options_list option."+r).clone(!0);$("#cmbArea option:not(.default)").remove(),$("#cmbArea").append(o),t&&!a?$("#cmbArea").find("option[value^='"+t+"']").prop("selected",!0):$("#cmbArea option.default").prop("selected",!0)}resetLngLat()}function selectedCity2(e,t){if(e){var a=$("#user_city").find("option[value='"+e+"']");a.prop("selected",!0);var i=a.attr("city_sn"),r=$("#area_options_list option."+i).clone(!0);$("#user_area option:not(.default)").remove(),$("#user_area").append(r),t?$("#user_area").find("option[value^='"+t+"']").prop("selected",!0):$("#user_area option.default").prop("selected",!0)}}function returnKeyword2(){var e=$.trim($("#searchInp").val()),t=$("#user_city option:selected").val(),a=$("#user_area option:selected").val(),i=$.trim($("#addr_name").val()),r=$("#cmbCity option:selected").val(),o=$("#cmbArea option:selected").val();e==i&&t==r&&a==o||(resetLngLat(),selectedCity(t,a),$("#addr_name").val(e)),$("#home_city").hide(),$("#cmbArea_wrap").show(),SCFlag=2,$("#select_wrap").show(),setSaveBtn(),showMainWin()}function setBtnStatus2(){var e=$("#user_city option:selected").val(),t=$("#user_area option:selected").val(),a=$.trim($("#searchInp").val());return e&&t&&a?($("#confirm_address").prop("disabled",!1).css({opacity:"1"}),!0):($("#confirm_address").prop("disabled",!0).css({opacity:".5"}),!1)}var geolocation,mGeocoder,placeSearch,jqueryXhr=null,timer,errFlag=0;