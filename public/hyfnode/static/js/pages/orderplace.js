function InitAddress(){var e=window.sessionStorage.getItem("priceaddress");if(e){addressDesc=JSON.parse(e);t=template("address-wrap",{address:{address:addressDesc.address,tel:addressDesc.mobile,username:addressDesc.username}});$("#address-part").html(t)}else{var t=template("address-wrap",{address:{address:"undefined undefined"}});$("#address-part").html(t)}}function InitService(){$.post("/hyfnode/base/service",{},function(e){serviceDesc=e.data.categories;for(var t=window.sessionStorage.getItem("orderplace_item")||0,a=0;a<serviceDesc.length;a++)serviceDesc[a].serviceitem==parseInt(t)+1&&(serviceDesc[a].active="active");var r=template("category-wrap",{categories:serviceDesc}),s=template("total-delivery-wrap",{total:serviceDesc[t].delivery_fee});$("#delivery-part").html(s),$("#category-part").html(r),$(".category-list-item").on("click",function(){$(".category-list-item").removeClass("active"),$(this).addClass("active");var e=$(this).attr("data-id"),t=_.filter(serviceDesc,function(t){return t.serviceitem==e});if(t.length>0){var a=template("total-delivery-wrap",{total:t[0].delivery_fee});$("#delivery-part").html(a)}})})}function getSearchParams(){for(var e={},t=location.search.substr(1).split(/&/g),a=0;a<t.length;a++)try{var r=t[a].split("=",2),s=r[0],i=decodeURIComponent(r[1]);e[s]=i}catch(e){}return e}function myDecodeUrl(e){var t=decodeURIComponent(decodeURIComponent(e));return JSON.parse(t)}function myalert(e,t){var a=template("alert-dialog-wrap",{tips:{title:e,content:t}});$("#dialog").html(a),$("#alert-dialog").show(),$("#dialog").on("click",".i-know-btn",function(e){$("#alert-dialog").hide()})}function CreateOrder(e){$.ajax({type:"POST",url:"/hyfnode/base/order/create",data:e,dataType:"json",success:function(e){e.data&&"0000"==e.data.resCode?window.location.href="/hyfnode/order":alert("出错了，请重新下单试试"),$(".loader").hide()},error:function(e,t){alert("出错了，请重新下单试试"),$(".loader").hide()}})}console.log("加载首页js");var addressDesc={},serviceDesc=[];InitAddress(),InitService(),$(".loader").hide();var params=getSearchParams();if(params.washing_date_text&&params.washing_time){var datetext=params.washing_date_text+" "+params.washing_time;$(".timeinput").text(datetext).addClass("has-time")}params.comment?($("#guest-part textarea").val(params.comment),orderPlaceData.comment=params.comment):$("textarea").val(""),$("#address-part").on("click","#address",function(){window.location.href="/hyfnode/addresslist?backurl=orderplace"}),$("#time-part").on("click",function(){$.contains($("#address").get(0),$(".add-address").get(0))?myalert("操作提示","请先填写/选择地址。"):window.location.href="/hyfnode/timectr?from=orderplace"});var oldStr;$("#guest-part textarea").on("input propertychange",function(){var e=$("#guest-part textarea").val(),t=(e=e.replace(/^(\u3000|\s|\t|\u00A0)*|(\u3000|\s|\t|\u00A0)*$/g,"")).match(/[^\x00-\x80]/g);Math.ceil((e.length+(t?t.length:0))/2)<=50?oldStr=e:$("#guest-part textarea").val(oldStr)}),$("footer div").on("click",function(){if(addressDesc&&addressDesc.mobile&&addressDesc.address)if(params.washing_date_text&&params.washing_time)if(0!=$("#guest-part textarea").val().length){var e=window.sessionStorage,t=JSON.parse(e.getItem("productInfo")).washing.length,a=window.sessionStorage.getItem("wx_login_openid")||"",r={telephone:addressDesc.mobile,clothesCount:t||1,orderAddress:addressDesc.address,placeOrderDate:params.washing_date_text,placeOrderDateArea:params.washing_time,leaveMessage:$("#guest-part textarea").val(),serviceItem:$(".category-list-item.active").attr("data-id"),openid:a};if($(".loader").show(),BMap&&BMap.Geolocation){var s=new BMap.Geolocation;s&&s.getCurrentPosition?s.getCurrentPosition(function(e){if(this.getStatus()==BMAP_STATUS_SUCCESS){var t=e.longitude||"",a=e.latitude||"";r.longitude=t,r.latitude=a}CreateOrder(r)},function(e){CreateOrder(r)}):CreateOrder(r)}else CreateOrder(r)}else myalert("提示","请填写问题或备注!");else myalert("提示","请选择取件时间!");else myalert("提示","请选择收件地址!")});